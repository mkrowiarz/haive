# Phase 2C: Database List/Clone/Dumps + Worktree Integration - Design

> **Status:** Approved
> **Date:** 2025-02-11
> **Scope:** Core database commands (db.list, db.clone, db.dumps) + worktree orchestrator integration

---

## Overview

Phase 2C completes the essential database operations and integrates them into the worktree workflow. When `db_per_worktree: true` in config, creating a worktree automatically clones the default database.

**Out of Scope:** PostgreSQL support (documented as future TODO in SPEC.md)

---

## New Database Commands

### db.list

List all databases in the container, excluding system databases.

**Parameters:** none

**Returns:**
```go
type DatabaseListResult struct {
    Databases []DatabaseInfo `json:"databases"`
}

type DatabaseInfo struct {
    Name      string `json:"name"`
    IsDefault bool   `json:"is_default"`
}
```

**Implementation:**
- Execute `SHOW DATABASES` via Docker exec
- Filter out system databases: `information_schema`, `mysql`, `performance_schema`, `sys`
- Mark which database matches the DSN's default database

**Engine command:** `BuildListCommand()` returns `["mysql", "-e", "SHOW DATABASES"]`

**No sizes** - Returns names and default flag only for simplicity.

---

### db.clone

Clone one database into another (dump + create + import in one operation).

**Parameters:**

| Parameter | Type   | Required | Default             | Description          |
|-----------|--------|----------|---------------------|----------------------|
| `source`  | string | no       | Default DB from DSN | Source database       |
| `target`  | string | yes      | —                   | Target database name  |

**Returns:**
```go
type CloneResult struct {
    Source   string        `json:"source"`
    Target   string        `json:"target"`
    Size     int64         `json:"size"`
    Duration time.Duration `json:"duration"`
}
```

**Implementation:**
1. Validate both source and target against `allowed` patterns
2. Create target database (if exists, error)
3. Dump source to temp file in `os.TempDir()`
4. Import temp file into target
5. Clean up temp file
6. Return result with size/duration

**No progress callbacks** - Local databases are small (50-100MB), synchronous operation is sufficient.

**Error cases:**
- Source not in allowed list → `ErrDbNotAllowed`
- Target not in allowed list → `ErrDbNotAllowed`
- Target already exists → error from `CREATE DATABASE`

---

### db.dumps

List available SQL dump files from the dumps directory.

**Parameters:** none

**Returns:**
```go
type DumpsListResult struct {
    Dumps []DumpFileInfo `json:"dumps"`
}

type DumpFileInfo struct {
    Name     string `json:"name"`
    Database string `json:"database"`
    Size     int64  `json:"size"`
    Modified string `json:"modified"` // ISO timestamp
}
```

**Implementation:**
- Read directory from `cfg.Database.DumpsPath` (default: `var/dumps`)
- Filter for `*.sql` files only
- Parse filename pattern `<database>_<timestamp>.sql`
- Sort by modification time (most recent first)
- Return list with size and timestamp

**Enforced naming convention:** Only recognizes files matching `<db>_<timestamp>.sql` pattern (as generated by `db.dump`)

**File not found:** If dumps directory doesn't exist, return empty list (not an error)

---

## Worktree Integration

### Updated CreateIsolatedWorktree Orchestrator

When `cfg.Worktrees.DBPerWorktree == true`:

1. **Create worktree** (existing behavior)
2. **Generate database name**: `<db_prefix>` + sanitized branch name (e.g., `app_wt_feature_booking_calendar`)
3. **Clone default database** to new database
4. **Patch `.env.local`** in worktree with new `DATABASE_URL`

**Database name sanitization:** Replace `/` and `-` with `_` (e.g., `feature/booking-calendar` → `feature_booking_calendar`)

**Updated return type:**
```go
type WorkflowCreateResult struct {
    WorktreePath   string `json:"worktree_path"`
    WorktreeBranch string `json:"worktree_branch"`
    DatabaseName   string `json:"database_name,omitempty"`
    ClonedFrom     string `json:"cloned_from,omitempty"`
}
```

**Config defaults:**
- `db_prefix` defaults to `<default_db>_wt_` (e.g., if default DB is `app`, prefix is `app_wt_`)

---

### New RemoveIsolatedWorktree Orchestrator

Remove worktree and optionally drop its associated database.

**Signature:**
```go
func RemoveIsolatedWorktree(projectRoot, branch string, dropDB bool) (*WorkflowRemoveResult, error)
```

**Parameters:**

| Parameter | Type    | Required | Default | Description                      |
|-----------|---------|----------|---------|----------------------------------|
| `branch`  | string  | yes      | —       | Branch name of the worktree      |
| `dropDB`  | boolean | no       | `true`  | Also drop the worktree's database |

**Returns:**
```go
type WorkflowRemoveResult struct {
    WorktreePath string `json:"worktree_path"`
    DatabaseName string `json:"database_name,omitempty"`
}
```

**Implementation:**
1. Calculate expected database name from branch + prefix
2. If `dropDB` and database exists in allowed list → drop database
3. Remove worktree via git

**Safety:** Only drops databases that match the naming pattern (prevents accidental drops)

---

## Implementation Plan

### Files to Modify

| File | Changes |
|------|---------|
| `internal/core/types/types.go` | Add `DatabaseInfo`, `DatabaseListResult`, `CloneResult`, `DumpFileInfo`, `DumpsListResult`, update `WorkflowCreateResult`, add `WorkflowRemoveResult` |
| `internal/executor/engines/engine.go` | Add `BuildListCommand()` to interface |
| `internal/executor/engines/mysql.go` | Implement `BuildListCommand()` |
| `internal/executor/database.go` | Add `List()` method to interface + `DockerDatabaseExecutor` implementation |
| `internal/core/commands/database.go` | Add `ListDBs()`, `CloneDB()`, `ListDumps()` functions |
| `internal/core/commands/workflow.go` | Update `CreateIsolatedWorktree()`, add `RemoveIsolatedWorktree()` |
| `internal/core/config/config.go` | Add default for `db_prefix` (`<default_db>_wt_`) |

### Files to Create

| File | Purpose |
|------|---------|
| `internal/core/commands/workflow_test.go` | Tests for orchestrators (extend existing database_test.go for new commands) |

### Implementation Order

1. **Types** - Add new result types to `types.go`
2. **Engine interface** - Add `BuildListCommand()` to `engine.go`
3. **MySQL engine** - Implement `BuildListCommand()` in `mysql.go`, add tests
4. **Database executor** - Add `List()` method to interface and implementation
5. **db.list command** - Implement `ListDBs()` in `database.go`, add tests
6. **db.clone command** - Implement `CloneDB()` in `database.go`, add tests
7. **db.dumps command** - Implement `ListDumps()` in `database.go`, add tests
8. **Config validation** - Add `db_prefix` default in `config.go`
9. **CreateIsolatedWorktree** - Update orchestrator with DB cloning
10. **RemoveIsolatedWorktree** - Add new orchestrator
11. **Orchestrator tests** - Create `workflow_test.go`

---

## Success Criteria

Phase 2C is complete when:
- ✅ All 11 implementation tasks completed
- ✅ `db.list` returns databases with default flag
- ✅ `db.clone` creates target database with cloned data
- ✅ `db.dumps` lists SQL files from dumps directory
- ✅ `CreateIsolatedWorktree` clones DB when `db_per_worktree: true`
- ✅ `RemoveIsolatedWorktree` drops DB when `drop_db: true`
- ✅ All tests passing
- ✅ Test coverage 80%+ for new code

---

## Notes

- PostgreSQL support explicitly out of scope (documented in SPEC.md as future TODO)
- No progress callbacks for `db.clone` (small local databases)
- Dump filename convention enforced for `db.dumps`
- Database sizes not included in `db.list` (names only for v1)
